import { NextRequest, NextResponse } from 'next/server';
import { getOpenAI, MODEL } from '@/lib/openai';

const WEB_APP_GUIDE = `
# คู่มือการใช้งาน Payroll System

## 1. Dashboard (หน้าแรก)
- แสดงสรุปข้อมูลเงินเดือนของพนักงานทั้งหมด
- เลือกรอบเงินเดือนได้จาก dropdown ด้านบน
- มีตารางแสดงรายละเอียดพนักงานแต่ละคน (OT, เงินเดือน, ภาษี)
- แสดงสถิติ: พนักงานที่ทำ OT เยอะที่สุด/น้อยที่สุด, ค่าเฉลี่ยแต่ละแผนก
- แสดงสรุปการเงิน: เงินเดือนรวม, ภาษีรวม, ประกันสังคม
- สามารถค้นหาพนักงานได้จาก search bar

## 2. พนักงาน (/employees)
- แสดงรายชื่อพนักงานทั้งหมด
- เพิ่มพนักงานใหม่: กดปุ่ม "เพิ่มพนักงาน" แล้วกรอกข้อมูล
  * รหัสพนักงาน (employee_id) - ห้ามซ้ำ
  * ชื่อ-นามสกุล
  * แผนก (เลือกจาก dropdown)
  * ตำแหน่ง
  * วันที่เริ่มงาน
  * เงินเดือนฐาน
- แก้ไขข้อมูล: กดไอคอน "แก้ไข" ที่แถวพนักงาน
- ลบพนักงาน: กดไอคอน "ลบ" (จะมี confirmation)

## 3. บันทึกเวลา (/attendance)
- แสดงข้อมูลเวลาเข้า-ออกงานของพนักงาน
- Import ข้อมูลจากเครื่องสแกนใบหน้า:
  * กดปุ่ม "Import ข้อมูล"
  * เลือกไฟล์ Excel/CSV ที่มีคอลัมน์: employee_id, scan_date, scan_type, scan_time
  * ระบบจะตรวจสอบรหัสพนักงานและข้ามรหัสที่ไม่มีในระบบ
  * แสดงผลสรุปการ import
- กรองข้อมูลตามวันที่ได้

## 4. การลางาน (/leave)
- แสดงประวัติการลางานของพนักงาน
- เพิ่มการลาใหม่:
  * เลือกพนักงาน
  * เลือกประเภทการลา: ลาป่วย (sick), ลากิจ (personal), ลาพักร้อน (annual)
  * ระบุวันที่เริ่ม-สิ้นสุด
  * ระบุเหตุผล
- อนุมัติ/ปฏิเสธการลา: กดปุ่มที่แถวการลา

## 5. คำนวณเงินเดือน (/payroll)
- แสดงผลการคำนวณเงินเดือนของพนักงาน
- เลือกรอบเงินเดือน (payroll period)
- ตารางแสดง:
  * เงินฐาน (base_salary)
  * ชั่วโมง OT (total_ot_hours)
  * ค่า OT (ot_amount)
  * เงินรวมก่อนหัก (gross_salary)
  * ภาษี (tax)
  * ประกันสังคม (social_security)
  * เงินสุทธิ (net_salary)
- สามารถเรียงลำดับตารางได้ (คลิกที่หัวคอลัมน์)
  * คลิกครั้งแรก: เรียงจากมากไปน้อย (↓)
  * คลิกครั้งที่สอง: เรียงจากน้อยไปมาก (↑)
  * คลิกครั้งที่สาม: ยกเลิกการเรียง
  * กด Ctrl/Cmd + คลิก: เรียงหลายคอลัมน์ (sub-sort)
- Search bar สำหรับค้นหาพนักงาน

## 6. รายงาน (/reports)
- สร้างรายงานต่างๆ
- Export ข้อมูลเป็น Excel/PDF
- รายงานที่มี:
  * สรุปเงินเดือนรายเดือน
  * รายงาน OT แยกตามแผนก
  * รายงานการลางาน
  * สลิปเงินเดือน (payslip)

## 7. AI Features (/ai-features)
- Chat กับ AI Assistant
- ถามคำถามเกี่ยวกับข้อมูลในระบบ
- ขอคำแนะนำการใช้งาน
- ปุ่ม chat ลอยอยู่มุมขวาล่างของทุกหน้า

## การคำนวณ OT
- อัตรา OT ปกติ: 1.5 เท่าของค่าจ้างต่อชั่วโมง
- อัตรา OT วันอาทิตย์: 3.0 เท่า
- ค่าจ้างต่อชั่วโมง = เงินเดือนฐาน / 240
- กะข้ามคืน (overnight shift): คำนวณแยกตามวัน

## การคำนวณภาษี
- เกณฑ์แบบขั้นบันได:
  * 0-150,000: 0%
  * 150,001-300,000: 5%
  * 300,001-500,000: 10%
  * 500,001-750,000: 15%
  * 750,001-1,000,000: 20%
  * 1,000,001-2,000,000: 25%
  * 2,000,001-5,000,000: 30%
  * 5,000,001 ขึ้นไป: 35%

## ประกันสังคม
- อัตรา 5% ของ gross salary
- สูงสุดไม่เกิน 750 บาท/เดือน

## Responsive Design
- รองรับการใช้งานบนมือถือและแท็บเล็ต
- เมนูแฮมเบอร์เกอร์บนมือถือ (≡ icon)
- ตารางจะแสดงเป็น card view บนหน้าจอเล็ก
- ปุ่มและ touch targets ขนาดเหมาะสมสำหรับสัมผัส
`;

export async function POST(request: NextRequest) {
  try {
    const { message } = await request.json();

    if (!message) {
      return NextResponse.json(
        { error: 'Message is required' },
        { status: 400 }
      );
    }

    const openai = getOpenAI();
    const completion = await openai.chat.completions.create({
      model: MODEL,
      messages: [
        {
          role: 'system',
          content: `คุณคือ AI Assistant ที่ช่วยแนะนำวิธีการใช้งานระบบ Payroll

คู่มือการใช้งาน:
${WEB_APP_GUIDE}

งานของคุณ:
1. ตอบคำถามเกี่ยวกับวิธีการใช้งานระบบ
2. อธิบายอย่างละเอียด step-by-step
3. ใช้ Markdown format เพื่อความสวยงาม
4. ใช้ bullet points, numbering, และ headings ที่เหมาะสม
5. ให้ตัวอย่างเมื่อเหมาะสม
6. เป็นมิตรและเข้าใจง่าย
7. ถ้าคำถามไม่เกี่ยวกับการใช้งาน ให้บอกว่าคุณช่วยเฉพาะเรื่องการใช้งานระบบ Payroll`,
        },
        {
          role: 'user',
          content: message,
        },
      ],
      temperature: 0.5,
    });

    const response = completion.choices[0]?.message?.content || 'ไม่สามารถสร้างคำตอบได้';

    return NextResponse.json({ response });
  } catch (error) {
    console.error('How-to error:', error);
    return NextResponse.json(
      { error: 'Failed to process how-to query' },
      { status: 500 }
    );
  }
}
